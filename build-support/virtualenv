#!/usr/bin/env bash
# Wrapper for self-bootstrapping virtualenv
set -e
VIRTUALENV_VERSION=1.11.4

VIRTUALENV_PACKAGE_LOCATION=${VIRTUALENV_PACKAGE_LOCATION:-https://pypi.python.org/packages/source/v/virtualenv}

function log() {
  echo -e "$@" 1>&2
}

function die() {
  (($# > 0)) && log "$@"
  exit 1
}

if [[ -z "$PY" ]]; then
  if which python2.7 >/dev/null; then
    PY=`which python2.7`
  else
    die 'No python2.7 interpreter found on the path.  Python will not work!' 1>&2
  fi
fi

log "Using $PY"

HERE=$(cd `dirname "${BASH_SOURCE[0]}"` && pwd)
if ! [ -f "$HERE/virtualenv-$VIRTUALENV_VERSION/BOOTSTRAPPED" ]; then
  pushd "$HERE"
  log "Downloading ${VIRTUALENV_PACKAGE_LOCATION}/virtualenv-$VIRTUALENV_VERSION.tar.gz..."
  curl -O ${VIRTUALENV_PACKAGE_LOCATION}/virtualenv-$VIRTUALENV_VERSION.tar.gz || \
    die "Failed to download ${VIRTUALENV_PACKAGE_LOCATION}/virtualenv-$VIRTUALENV_VERSION.tar.gz."
  tar zxvf virtualenv-$VIRTUALENV_VERSION.tar.gz || \
    die "Failed to extract ${VIRTUALENV_PACKAGE_LOCATION}/virtualenv-$VIRTUALENV_VERSION.tar.gz."
  # TODO(ksweeney): Checksum
  touch virtualenv-$VIRTUALENV_VERSION/BOOTSTRAPPED  # 2PC
  popd
fi

exec "$PY" "$HERE/virtualenv-$VIRTUALENV_VERSION/virtualenv.py" "$@"
