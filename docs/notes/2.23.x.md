# 2.23.x Release Series

Pants 2 is a fast, scalable, user-friendly build system for codebases of all sizes. It's currently focused on Python, Go, Java, Scala, Kotlin, Shell, and Docker, with support for other languages and frameworks coming soon.

Individuals and companies can now [sponsor Pants financially](https://www.pantsbuild.org/sponsorship).

Pants is an open-source project that is not owned or controlled by any one company or organization, and does incur some expenses. These expenses are managed by Pants Build, a non-profit that was established for this purpose. This non-profit's only source of revenue is sponsorship by individuals and companies that use Pants.

We offer [formal sponsorship tiers for companies](https://www.pantsbuild.org/sponsorship), as well as individual sponsorships via [GitHub](https://github.com/sponsors/pantsbuild).

## What's New

### Highlights

### Overall

The deprecations for the `--changed-dependees` option and the `dependees` goal have expired. Use the equivalent [`--changed-dependents` option](https://www.pantsbuild.org/2.23/reference/subsystems/changed#dependents) or [`dependents` goal](https://www.pantsbuild.org/2.23/reference/goals/dependents) instead.

### Remote caching/execution

The deprecation for the `[GLOBAL].remote_auth_bearer_token_path` option has expired. Use [the `[GLOBAL].remote_auth_bearer_token = "@/path/to/file"` option](https://www.pantsbuild.org/2.23/reference/global-options#remote_oauth_bearer_token) instead.

### Fine grained diff with line numbers

This release introduces `Target.origin_sources_blocks` field that allows any
plugin to define dependencies on individual blocks of code rather that the
whole file. The `--changed-since` logic was updated  to calculate fine grained
diff based on line numbers and compare the changed lines to
`origin_sources_blocks` to figure out which targets changed.

This feature is not used by any real plugin yet, but you can look at the [test
plugin](https://github.com/pantsbuild/pants/tree/2.23.x/testprojects/pants-plugins/src/python/python_constant/target_types.py)
for inspiration. To opt into the feature set the flag
`--enable-target-origin-sources-blocks`.

### Goals

#### Package

The `output_path` field present on targets which can be packaged by `pants package` is now based on a template so that you can use parts of `output_path`'s default behavior when overriding it on a target. For example, you can use the template replacement `${{spec_path_normalized}}` to obtain the default output directory for the target (i.e., the directory in which the target lives with slashes replaced by dots).

### Backends

#### BUILD

Support for parametrizing grouped parametrizations. (e.g. `**parametrize(resolve=parametrize("a", "b"), ...)`). This works for `___defaults__` as well, as long as it is specified per target type rather than using `all`.

#### Docker

Docker inference is improved. Pants can now make inferences by target address for targets supporting `pants package`, and `file` targets can be included by filename. See the [documentation on Docker dependency inference](https://www.pantsbuild.org/2.23/docs/docker#dependency-inference-support) for details

Experimental support for a rust-based dockerfile parser can be enabled via `[dockerfile-parser].use_rust_parser` option.

#### Scala

Source files no longer produce a dependency on Scala plugins. If you are using a Scala plugin that is also required by the source code (such as acyclic), please add an explicit dependency or set the `packages` field on the artifact.

The deprecation for `crossversion="partial"` on `scala_artifact` has expired. Use [`crossversion="binary"`](https://www.pantsbuild.org/2.23/reference/targets/scala_artifact#crossversion) instead.

The Scala dependency inference now understand usages of the `_root_` package name as a marker for disambiguating between colliding dependencies and will try to resolve those symbols as absolute. For instance, `import _root_.io.circe.syntax` will now be understood as an import of `io.circie.syntax`.

Scala dependency inference now also understands types refered to only by pattern matching cases such as `case MyType() =>`. These used to require manually adding a dependency if the type was defined in a separate file even if it was in the same package. This is now inferred.

#### NEW: Trufflehog

A new experimental `pants.backend.experimental.tools.trufflehog` backend was added to support
[`trufflehog`](https://trufflesecurity.com/trufflehog) secret scanning. The backend supports ignoring certain paths by adding, for example:

```
[trufflehog]
exclude = ["**/tests/*"]
```

The backend linter will also load a Trufflehog [configuration file](https://github.com/trufflesecurity/trufflehog?tab=readme-ov-file#regex-detector-example) (passed via `trufflehog -c trufflehog-config.yaml`), as long as the configuration file is placed in the root of your codebase with filename: `trufflehog-config.yaml`

#### Python

[The `pants.backend.experimental.python.typecheck.pyright` backend](https://www.pantsbuild.org/2.23/reference/subsystems/pyright) now uses version 1.1.365 by default.

The deprecation for the `pants.backend.experimental.python.lint.ruff` backend path has expired. Use `pants.backend.experimental.python.lint.ruff.check` instead.

The default version of the `ruff` tool has been updated from 0.4.4 to 0.4.9.

The default version of the pex tool has been updated from 2.3.1 to 2.3.3.

Fix running python source files that have dashes in them (bug introduced in 2.20). For example: `pants run path/to/some-executable.py`

A new `entry_point_dependencies` field is now available for `python_tests` and `python_test` targets. This allows tests
to depend on a subset (or all) of the `entry_points` defined on `python_distribution` targets. A dependency defined in
`entry_point_dependencies` emulates an editable install of those `python_distribution` targets. Instead of including
all of the `python_distribution`'s sources, only the specified entry points are made available. The entry_points metadata
is also installed in the pytest sandbox so that tests (or the code under test) can load that metadata via `pkg_resources`.
To use this, enable the `pants.backend.experimental.python` backend.

Exported virtualenvs can use Pants-provided Python if a `PythonProvider` backend is enabled (like `pants.backend.python.providers.experimental.pyenv`). Before Pants 2.23, virtualenv exports could only use pre-installed python binaries.

The docs for the `check` goal have been updated to state that third-party type stubs must be installed in the same resolve as the code.

#### Terraform

The default version of terraform has been updated from 1.7.1 to 1.9.0.

The `tfsec` linter now works on all supported platforms without extra config.

`tfsec` versions are now provided in semver format, without "v" prefixes.

Sandboxes for the `experimental-deploy` deployment (the execution of `terraform apply`) can now be preserved with `--keep-sandboxes`.

Terraform Lockfiles now participate in the dependency graph. `--changed-since` will now include targets affected by the changed lockfile.

#### Javascript

The Node.js runtime now uses version 20.15.1 by default. This is 2 major version upgrades from the 16.x series, which was used before.
Additionally, the default versions of the various package managers have been updated:

npm: 8.5.5 -> 10.8.1
pnpm: 9.5.0 (9.x)
yarn: 1.22.22 (1.x)

Nodejs processes configured with `extra_env_vars`, e.g.
[`javascript_test`](https://www.pantsbuild.org/2.23/reference/targets/javascript_test),
now supports extending the `PATH` variable of such processes. Passing `extra_env_vars=["PATH=/usr/bin"]` was previously
silently ignored.

Two issues with pants `corepack` integration has been resolved:

1. The `"packageManager"` package.json field is now respected for other package.json than the one at the build root.
Previously, if for example a nodejs tool was configured with a resolve based off of such a package.json, the bug caused
pants to invoke `corepack`s default versions of the package managers instead.
2. The pants.toml option `[nodejs].package_manager` can now be assigned any of the supported package managers
(npm, pnpm, yarn) without providing a corresponding `[nodejs].package_managers` version setting. The version is then
entirely handled by `corepack`. Previously this mode caused pants to fail.

The internal installation mechanism for node_modules has changed.
Previously, Pants installed each package separately in sandboxes and merged the results, creating a node_modules for all dependent packages in the workspace.
Now, this is delegated to the package managers, using each package manager's support for workspaces.

This fixes an issue with integrity file collisions when newer versions of package managers (e.g. the [hidden lockfiles](https://docs.npmjs.com/cli/v9/configuring-npm/package-lock-json#hidden-lockfiles) introduced in npm v7).

`pants export --resolve=<js-resolve>` now has basic support for exporting the package manager installation artifacts
including `node_modules`. This can be used to inspect the installation, or to enable IDE:s to discover the packages.

Pants will output a more helpful error message if there is no `name` field defined in the `package.json` file, or if the `name` field is empty.

#### Shell

The `tailor` goal now has independent options for tailoring `shell_sources` and `shunit2_tests` targets. The option was split from `tailor` into [`tailor_sources`](https://www.pantsbuild.org/2.23/reference/subsystems/shell-setup#tailor_sources) and [`tailor_shunit2_tests`](https://www.pantsbuild.org/2.23/reference/subsystems/shell-setup#tailor_shunit2_tests).

#### Docker

Fixed a bug where the internal Docker BuildKit parser would return `<unknown> image_id` if the BuildKit output used step durations.

#### Helm

Fixed pulling `helm_artifact`s from OCI repositories.

Improve warning on dependent images not being found. Pants can now validate that values passed into Helm charts that will be used for container images are valid `docker_image` targets or known 3rd-party images. See the [documentation in the helm-infer subsystem](https://www.pantsbuild.org/2.23/reference/subsystems/helm-infer).

#### Shell

Added `workspace_invalidation_sources` field to `adhoc_tool` and `shell_command` target types. This new field allows declaring that these targets depend on files without bringing those files into the execution sandbox, but that the target should still be re-executed if those files change. This is intended to work with the `workspace_environment` support where processes are executed in the workspace and not in a separate sandbox.

#### Workunit logger

The `pants.backend.experimental.tools.workunit_logger` backend will now create directory specified by [the `logdir` option](https://www.pantsbuild.org/2.23/reference/subsystems/workunit-logger#logdir) if it doesn't already exist.

### Plugin API changes

Fixed bug with workspace environment support where Pants used a workspace environment when it was searching for a local environment.

Support documenting macro constants using `MY_CONSTANT: Annotated[some_type, Doc("my help text ...")] = some_value`.

Fixed bug where files larger than 512KB were being materialized to a process's sandbox without write permissions if the file was only globbed by `output_directories=(".",)`.

Fixed bug where using `RuleRunner` in plugin tests caused `ValueError` that complains about not finding build root sentinel files. Note that you may have to adjust your tests to account for the new `BUILDROOT` file that `RuleRunner` now injects in the sandbox it creates for each test. For example, a test that uses a `**` glob might have to add `!BUILDROOT` to exclude the `BUILDROOT` file, or otherwise account for its presence when inspecting a sandbox or its digest.

### Other minor tweaks

The "Provided by" information in the documentation now correctly reflects the proper backend to enable to activate a certain feature.

Metadata for paths in the repository can now be requested via the `PathMetadataRequest` and `PathMetadataResult` types. This API is intended for rules which need access to the "full" metadata for a path.

### New call-by-name syntax for @rules

Pants has a new mechanism for `@rule` invocation in backends. In this release the following backends were migrated to use this new mechanism. There should not be any user-visible effects, but please be on the lookout for any unusual bugs or error messages.

- `cc`
- `cue`
- `debian`
- `makeself`
- `semgrep`
- `sql`
- `swift`
- `trufflehog`
- `yamllint`

## Full Changelog

For the full changelog, see the individual GitHub Releases for this series: <https://github.com/pantsbuild/pants/releases>
