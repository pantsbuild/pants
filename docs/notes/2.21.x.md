# 2.21.x Release Series

Pants 2 is a fast, scalable, user-friendly build system for codebases of all sizes. It's currently focused on Python, Go, Java, Scala, Kotlin, Shell, and Docker, with support for other languages and frameworks coming soon.

Individuals and companies can now [sponsor Pants financially](https://www.pantsbuild.org/sponsorship).

Pants is an open-source project that is not owned or controlled by any one company or organization, and does incur some expenses. These expenses are managed by Pants Build, a non-profit that was established for this purpose. This non-profit's only source of revenue is sponsorship by individuals and companies that use Pants.

We offer [formal sponsorship tiers for companies](https://www.pantsbuild.org/sponsorship), as well as individual sponsorships via [GitHub](https://github.com/sponsors/pantsbuild).

## What's New

### Highlights

- All built-in backends now support the `[test].attempts_default` option to automatically retry tests.
- Significant speed-ups when manipulating Python dependencies, especially huge ones like PyTorch.
- When a `pants test ...` run in CI fails, the summary now includes suggested invocation to copy-paste and re-run locally.
- The `__defaults__` symbol now applies to targets generated by a target generator, in addition to targets written literally in BUILD files.

Keep reading to see the details and what's also included.

### Overall

All built-in targets that support testing with the `pants test` goal now support automatic retries, using [the `[test].attempts_default` option](https://www.pantsbuild.org/2.21/reference/goals/test#attempts_default).

When running in CI, the printed summary at the end of a `pants test ...` run will now include single invocation to rerun all failing tests, if any. This can be controlled by [the new `[test].show_rerun_command` option](https://www.pantsbuild.org/2.21/reference/goals/test#show_rerun_command).

Option values can now be optionally [read from files using `@?...`](https://www.pantsbuild.org/2.21/docs/using-pants/key-concepts/options#reading-individual-option-values-from-files). For instance, `opt = "@some_file.txt"` will give an error if `some_file.txt` does not exist, but the new syntax `opt = "@?some_file.txt"` will just leave the option unset.

The `stats` subsystem can now output structured data, using [the new `[stats].format = "jsonlines"` option](https://www.pantsbuild.org/2.21/reference/subsystems/stats#format). The structured output can make it easier to ingest and analyze Pants stats data, for example, tracking information about CI builds.

Introspection goals have had a few improvements:

* [`pants peek ...`](https://www.pantsbuild.org/2.21/docs/using-pants/project-introspection#peek---programmatically-inspect-a-target) now includes a `goals` field which will return a curated list of goals that can be run on the target

* Using the `json` format for [`pants dependencies ...`](https://www.pantsbuild.org/2.21/reference/goals/dependencies#format) or [`pants dependencies ...`](format#format) now correctly obeys the `output_file` setting.

### BUILD files

[The `__defaults__` symbol](https://www.pantsbuild.org/2.21/docs/using-pants/key-concepts/targets-and-build-files#field-default-values) will now set default values for generated targets too. For instance, `__defaults__({python_source: dict(skip_black=True)})` will now apply to the `python_source` targets generated by a `python_sources` target, without having to write `__defaults__({(python_source, python_sources): ...})`.

The [visibility rules](https://www.pantsbuild.org/2.21/docs/using-pants/validating-dependencies) now supports using `dict`s for rules, in addition to strings, the same as a selectors. This means, for instance, `{"path": "foo/bar.py", "action": "deny"}` is equivalent to `"!foo/bar.py"`.

Targets that [use parametrize groups](https://www.pantsbuild.org/2.21/docs/using-pants/key-concepts/targets-and-build-files#parametrizing-targets) depending on other parametrized targets now match by the name passed as the positional argument to `parametrize`.

### Backends

#### Docker

The [`cache_from` field](https://www.pantsbuild.org/2.21/reference/targets/docker_image#cache_from) on `docker_image` now supports multiple values.

The [new `extra_run_args` field](https://www.pantsbuild.org/2.21/reference/targets/docker_image#extra_run_args) on `docker_image` allows adding extra arguments that are passed into the `docker run ...` invocation when running the image with `pants run`.

Pants now correctly extracts the image ID when using `docker buildx` version 0.13.1 or greater.

Note: existing code that sets `__defaults__(all=dict(extra_build_args=...))` to apply to `docker_image` targets will start applying to `pex_binary` targets too, since that target now has a field of the same name. Use `__defaults__({docker_image: dict(extra_build_args=...)})` instead.

#### Go

Failing `go_package` tests can now be automatically retried by setting [the `[test].attempts_default` option](https://www.pantsbuild.org/2.21/docs/go#retries).

Go mod files referring to Go versions with patch (like `go 1.21.0`) no longer cause Pants to crash.

#### Helm

Failing `helm_unittest_test` tests can now be automatically retried by setting [the `[test].attempts_default` option](https://www.pantsbuild.org/2.21/docs/helm#retries).

[The `sources` field](https://www.pantsbuild.org/2.21/reference/targets/helm_chart#sources) of `helm_chart` targets now includes documentation files like `README.md` and  `values.schema.json` so that they are available once published.

Versions 3.13.3 and 3.14.3 of the Helm tool are now [known](https://www.pantsbuild.org/2.21/reference/subsystems/helm#known_versions). Version 3.14.3 is now [the default version](https://www.pantsbuild.org/2.21/reference/subsystems/helm#version).

The `experimental-deploy` goal now has built-in support for [the `--dry-run` option](https://www.pantsbuild.org/2.21/reference/goals/experimental-deploy#dry_run), which passes that to the underlying Helm invocation.

[The `helm-k8s-parser` subsystem](https://www.pantsbuild.org/2.21/reference/subsystems/helm-k8s-parser) now uses `hikaru` version 0.16.0b0 by default. [The `helm-post-renderer` subsystem](https://www.pantsbuild.org/2.21/reference/subsystems/helm-post-renderer) now uses `yamlpath` version 3.8.1 by default.

#### JavaScript

Failing `javascript_test` tests can now be automatically retried by setting [the `[test].attempts_default` option](https://www.pantsbuild.org/2.21/reference/goals/test#attempts_default).

`package_json` targets using yarn v2 or greater as the package manager are now supported.

#### JVM

Failing `kotlin_junit_test`, `junit_test`, and `scala_junit_test` tests can now be automatically retried by setting [the `[test].attempts_default` option](https://www.pantsbuild.org/2.21/docs/jvm/java-and-scala#retries).

##### Scala

Scalafix can now be run by Pants using the [new `pants.backend.experimental.scala.lint.scalafix` backend](https://www.pantsbuild.org/2.21/docs/jvm/java-and-scala#fix-scala-code).

#### Python

All built-in tool lockfiles are now configured to support Python 3.12, if the underlying tool version does.

Any PEX files Pants builds internally now take less work to build, meaning running tools and tests can be faster. These PEX files are now built with the `--no-pre-install-wheels` flag and thus directly use the wheels for third-party dependencies, without repackaging them. This is particularly valuable for requirements with huge wheels like PyTorch. [One benchmark](https://github.com/pex-tool/pex/issues/2292#issuecomment-1854582647) indicates key parts of build a pex file containing PyTorch are several minutes faster. This speed up applies for all tools and is visible even with smaller wheels. The author of these release notes observed the time to run mypy from scratch dropped from 150s to 100s in a production codebase.

The [new `extra_build_args` field](https://www.pantsbuild.org/2.21/reference/targets/pex_binary#extra_build_args) on `pex_binary` allows passing arbitrary additional arguments to the underlying pex invocation when packaging those targets. (Note: existing code that sets `__defaults__(all=dict(extra_build_args=...))` to apply to `docker_image` targets will thus start applying this to `pex_binary` targets too. Use `__defaults__({docker_image: dict(extra_build_args=...)})` instead.)

Pants now uses pex [version 2.3.1 by default](https://www.pantsbuild.org/2.21/reference/subsystems/pex-cli#version), and requires version 2.3.0 or greater.

[The Ruff backend](https://www.pantsbuild.org/2.21/reference/subsystems/ruff) now uses version 0.3.0 by default.

The new [`skip_ruff_check`](https://www.pantsbuild.org/2.21/reference/targets/python_source#skip_ruff_check) and [`skip_ruff_format`](https://www.pantsbuild.org/2.21/reference/targets/python_source#skip_ruff_format) fields on targets like `python_source` and `python_test` allow stopping either the linter or formatter specifically from running on that target. The [existing `skip_ruff` field](https://www.pantsbuild.org/2.21/reference/targets/python_source#skip_ruff) continues to stop both the linter and formatter from running.

[The `runtime` field](https://www.pantsbuild.org/2.21/reference/targets/python_google_cloud_function#runtime) of the `python_google_cloud_function` target now supports `python312`.

Virtualenvs exported with `pants export ...` have improved in two ways (Note: these apply only when using [`py_resolve_format = "mutable_virtualenv"`](https://www.pantsbuild.org/2.21/reference/goals/export#py_resolve_format), which is the default):

* They include Pants' resolve name in the shell prompt, when activated.

* The [new `py_hermetic_scripts` option](https://www.pantsbuild.org/2.21/reference/goals/export#py_hermetic_scripts) allows disabling the default behaviour of rewriting scripts to be hermetic (ignore system libraries and configuration), to, for example, allow IDEs like PyCharm to inject its debugger, coverage, or other IDE-specific libs when running a script.

Default module mappings were added for more modules: `antlr4-python3-runtime`, `auth0-python`, `biopython`, `cloud-sql-python-connector`, `coolprop`, `databricks-sdk`, `databricks-sql-connetor`, `delta-spark`, `django-activity-stream`, `django-notifications-hq`, `django-oauth-toolkit`, `django-two-factor-auth`, `djangorestframework-jwt`, `dnspython`, `drf-api-tracking`, `faiss-cpu`, `faiss-gpu`, `fonttools`, `grpcio-status`, `grpcio-testing`, `matplotlib`, `matrix-nio`, `netcdf4`, `o365`, `py-healthcheck`, `pycryptodome`, `perfa`, `pynacl`, `pyshp`, `python-sat`, `pywavelets`, `robotraconteur`, `sisl`. The mappings for `opentelemetry` have been restored after a regression in 2.20.0 (NB. this fix was released in 2.20.1 too).

The default version for many subsystems/backends has been updated:

- [`coverage-py`](https://www.pantsbuild.org/2.21/reference/subsystems/coverage-py): 7.2.7
- [`debugpy`](https://www.pantsbuild.org/2.21/reference/subsystems/debugpy): 1.6.7.post1
- [`pants.backend.python.lint.autoflake`](https://www.pantsbuild.org/2.21/reference/subsystems/autoflake): 2.1.1
- [`pants.backend.python.lint.bandit`](https://www.pantsbuild.org/2.21/reference/subsystems/bandit): 1.7.5
- [`pants.backend.python.lint.black`](https://www.pantsbuild.org/2.21/reference/subsystems/black): 23.3.0
- [`pants.backend.python.typecheck.mypy`](https://www.pantsbuild.org/2.21/reference/subsystems/mypy): 1.4.1
- [`pants.backend.python.lint.pyupgrade`](https://www.pantsbuild.org/2.21/reference/subsystems/pyupgrade): 3.3.2
- [`pants.backend.python.lint.yapf`](https://www.pantsbuild.org/2.21/reference/subsystems/yapf): 0.40.2

The deprecation has expired for the `python_awslambda` target alias: use the [new `python_aws_lambda_function` target](https://www.pantsbuild.org/2.21/reference/targets/python_aws_lambda_function) instead.

#### Shell

[The `pants.backend.shell.lint.shellcheck` backend](https://www.pantsbuild.org/2.21/reference/subsystems/shellcheck) now uses [version 0.10.0 by default](https://www.pantsbuild.org/2.21/reference/subsystems/shellcheck#version).

Failing `shunit2_test` and `experimental_test_shell_command` tests can now be automatically retried by setting [the `[test].attempts_default` option](https://www.pantsbuild.org/2.21/docs/shell#retries).

#### Terraform

The `experimental-deploy` goal now has built-in support for [the `--dry-run` option](https://www.pantsbuild.org/2.21/reference/goals/experimental-deploy#dry_run), which runs `terraform plan` instead of `terraform apply`.

[The `terraform-hcl2-parser` subsystem](https://www.pantsbuild.org/2.21/reference/subsystems/terraform-hcl2-parser) now uses `python-hcl2` version 4.3.2 by default.

#### Yaml

[The `pants.backend.experimental.tools.yamllint` backend](https://www.pantsbuild.org/2.21/reference/subsystems/yamllint) now uses version 1.32.0 by default.

### Plugin API changes

Plugins that define target generators should set the `generated_target_cls` class var to the targets that they generate. This ensures that `__defaults__` set for that `generated_target_cls` class are applied to the targets generated by the plugin. ([#20649](https://github.com/pantsbuild/pants/pull/20649))

[The new `pants.backend.project_info.peek.HasAdditionalTargetDataFieldSet` union](https://www.pantsbuild.org/2.21/docs/writing-plugins/the-target-api/concepts#adding-information-to-pants-peek-output) allows attaching arbitrary information to targets. This is shown in the `peek` output for these targets by using `pants peek --include-additional-info ...`.

[The new `pants.core.goals.resolves.ExportableTool` union](https://www.pantsbuild.org/2.21/docs/writing-plugins/common-subsystem-tasks#making-subsystems-exportable-with-their-default-lockfile) allows subsystems and tools to be exported with `pants export ...`, similar to a user resolve. ([#20730](https://github.com/pantsbuild/pants/pull/20730))

The `implicit_value` keyword argument for option registration is no longer supported. ([#20762](https://github.com/pantsbuild/pants/pull/20762))

## Full Changelog

For the full changelog, see the individual GitHub Releases for this series: https://github.com/pantsbuild/pants/releases
