
# GENERATED, DO NOT EDIT!
# To change, edit build-support/travis/travis.yml.mustache and run
# ./pants --quiet run build-support/travis:generate_travis_yml > .travis.yml
#
# Tip: Copy the generated `.travis.yml` into https://yamlvalidator.com to validate the YAML
# and see how the entries resolve to normalized JSON (helpful to debug anchors).


# Conditions are documented here: https://docs.travis-ci.com/user/conditions-v1
conditions: v1

if: commit_message !~ SKIP_FULL_CI

# -------------------------------------------------------------------------
# Global setup
# -------------------------------------------------------------------------

env:
  global:
    - PANTS_CONFIG_FILES="${TRAVIS_BUILD_DIR}/pants.travis-ci.ini"
    - LC_ALL="en_US.UTF-8"
    - BOOTSTRAPPED_PEX_BUCKET=ci-public.pantsbuild.org
    - BOOTSTRAPPED_PEX_KEY_PREFIX=${TRAVIS_BUILD_NUMBER}/${TRAVIS_BUILD_ID}/pants.pex
    - BOOTSTRAPPED_PEX_URL_PREFIX=s3://${BOOTSTRAPPED_PEX_BUCKET}/${BOOTSTRAPPED_PEX_KEY_PREFIX}
    - PYENV_PY27_VERSION=2.7.15
    - PYENV_PY36_VERSION=3.6.8
    - PYENV_PY37_VERSION=3.7.2
    # NB: Linux shards use Pyenv to pre-install Python. We must not override
    # PYENV_ROOT on those shards, or their Python will no longer work.
    - PYENV_ROOT="${PYENV_ROOT:-${HOME}/.pants_pyenv}"
    - PATH="${PYENV_ROOT}/shims:${PATH}"
    - AWS_CLI_ROOT="${HOME}/.aws_cli"

# -------------------------------------------------------------------------
# Cache config
# -------------------------------------------------------------------------

# Travis cache config for jobs that build the native engine.
native_engine_cache_config: &native_engine_cache_config
  before_cache:
    # Ensure permissions to do the below removals, which happen with or without caching enabled.
    - sudo chown -R travis:travis "${HOME}" "${TRAVIS_BUILD_DIR}"
    # Kill all python bytecode in our cached venvs.  Some files appear to
    # get bytecode compiled in non-yet-understood circumstances leading to
    # a full cache re-pack due to new bytecode files.
    - find build-support -name "*.py[co]" -delete
  cache:
    # The default timeout is 180 seconds, and our larger cache uploads exceed this.
    # TODO: Figure out why we have such large caches (2-7GB) and try to trim them.
    timeout: 500
    directories:
      - ${AWS_CLI_ROOT}
      - ${PYENV_ROOT}
      - ${HOME}/.cache/pants/rust/cargo
      - build-support/pants_dev_deps.py27.venv
      - build-support/pants_dev_deps.py36.venv
      - build-support/pants_dev_deps.py37.venv
      - src/rust/engine/target

# Travis cache config for jobs that run a bootstrapped pants.pex.
pants_run_cache_config: &pants_run_cache_config
  before_cache:
    # Ensure permissions to do the below removals, which happen with or without caching enabled.
    - sudo chown -R travis:travis "${HOME}" "${TRAVIS_BUILD_DIR}"
    # The `ivydata-*.properties` & root level `*.{properties,xml}` files'
    # effect on resolution time is in the noise, but they are
    # re-timestamped in internal comments and fields on each run and this
    # leads to travis-ci cache thrash.  Kill these files before the cache
    # check to avoid un-needed cache re-packing and re-upload (a ~100s
    # operation).
    - find ${HOME}/.ivy2/pants -type f -name "ivydata-*.properties" -delete
    - rm -f ${HOME}/.ivy2/pants/*.{css,properties,xml,xsl}
    # We have several tests that do local file:// url resolves for
    # com.example artifacts, these disrupt the cache but are fast since
    # they're resolved from local files when omitted from the cache.
    - rm -rf ${HOME}/.ivy2/pants/com.example
    # Render a summary to assist with further tuning the cache.
    - du -m -d2 ${HOME}/.cache/pants | sort -r -n
  cache:
    # The default timeout is 180 seconds, and our larger cache uploads exceed this.
    # TODO: Figure out why we have such large caches (2-7GB) and try to trim them.
    timeout: 500
    directories:
      - ${AWS_CLI_ROOT}
      - ${PYENV_ROOT}
      - ${HOME}/.cache/pants/tools
      - ${HOME}/.cache/pants/zinc
      - ${HOME}/.ivy2/pants
      # TODO(John Sirois): Update this to ~/.npm/pants when pants starts
      # using its own isolated cache:
      #   https://github.com/pantsbuild/pants/issues/2485
      - ${HOME}/.npm

# -------------------------------------------------------------------------
# AWS
# -------------------------------------------------------------------------

# We use AWS S3 to avoid unnecessary work in CI. Specifically, the bootstrap
# shards create a pants.pex, and then upload it to S3 for all of the test
# shards to pull down.

aws_deploy_pants_pex: &aws_deploy_pants_pex >
  aws --no-sign-request --region us-east-1 s3 cp ${TRAVIS_BUILD_DIR}/pants.pex ${BOOTSTRAPPED_PEX_URL_PREFIX}.${BOOTSTRAPPED_PEX_KEY_SUFFIX}

aws_get_pants_pex: &aws_get_pants_pex >
  ./build-support/bin/get_ci_bootstrapped_pants_pex.sh ${BOOTSTRAPPED_PEX_BUCKET} ${BOOTSTRAPPED_PEX_KEY_PREFIX}.${BOOTSTRAPPED_PEX_KEY_SUFFIX}

# -------------------------------------------------------------------------
# Generic shard setups
# -------------------------------------------------------------------------

run_tests_under_pantsd: &run_tests_under_pantsd >
  USE_PANTSD_FOR_INTEGRATION_TESTS="true"

base_linux_config: &base_linux_config
  os: linux
  dist: xenial
  sudo: required
  python:
    - "2.7"
    - "3.6"
    - "3.7"
  addons:
    apt:
      packages:
        - lib32stdc++6
        - lib32z1
        - lib32z1-dev
        - gcc-multilib
        - python-dev
        - openssl
        - libssl-dev
        - jq
        - unzip
  language: python
  before_install:
    - ./build-support/bin/install_aws_cli_for_ci.sh
    # TODO(John Sirois): Get rid of this in favor of explicitly adding pyenv versions to the PATH:
    #   https://github.com/pantsbuild/pants/issues/7601
    - pyenv global 2.7.15 3.6.7 3.7.1
  after_failure:
    - ./build-support/bin/ci-failure.sh

py27_linux_config: &py27_linux_config
  <<: *base_linux_config

py36_linux_config: &py36_linux_config
  <<: *base_linux_config

py37_linux_config: &py37_linux_config
  <<: *base_linux_config

base_linux_test_config: &base_linux_test_config
  <<: *base_linux_config
  <<: *pants_run_cache_config
  before_install:
    - PATH="/usr/lib/jvm/java-8-openjdk-amd64/jre/bin":$PATH
    - JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
    - sudo sysctl fs.inotify.max_user_watches=524288
    - ./build-support/bin/install_aws_cli_for_ci.sh
    - pyenv global 2.7.15 3.6.7 3.7.1
  before_script:
    - *aws_get_pants_pex

py27_linux_test_config: &py27_linux_test_config
  <<: *py27_linux_config
  <<: *base_linux_test_config
  env:
    - &py27_linux_test_config_env >
      BOOTSTRAPPED_PEX_KEY_SUFFIX=py27.linux

py36_linux_test_config: &py36_linux_test_config
  <<: *py36_linux_config
  <<: *base_linux_test_config
  env:
    - &py36_linux_test_config_env >
      BOOTSTRAPPED_PEX_KEY_SUFFIX=py36.linux

py37_linux_test_config: &py37_linux_test_config
  <<: *py37_linux_config
  <<: *base_linux_test_config
  env:
    # TODO(https://github.com/tensorflow/tensorflow/issues/27078): tensorflow==1.13.1 on python 3.7.2 for Linux uses the new C++ ABI, which may be an error.
    - &py37_linux_test_config_env BOOTSTRAPPED_PEX_KEY_SUFFIX=py37.linux PANTS_NATIVE_BUILD_STEP_CPP_COMPILE_SETTINGS_DEFAULT_COMPILER_OPTION_SETS="[]"

base_osx_config: &base_osx_config
  os: osx
  language: generic
  addons:
    brew:
      packages:
      - openssl

py27_osx_config: &py27_osx_config
  <<: *base_osx_config
  # NB: We ensure sane python2 and python3 interpreters are available on the PATH for scripting
  # against.
  env:
    - &py27_osx_config_env >
      PATH="/usr/local/opt/openssl/bin:${PATH}"
      LDFLAGS="-L/usr/local/opt/openssl/lib"
      CPPFLAGS="-I/usr/local/opt/openssl/include"
      PATH="${PYENV_ROOT}/versions/${PYENV_PY27_VERSION}/bin:${PATH}"
      PATH="${PYENV_ROOT}/versions/${PYENV_PY36_VERSION}/bin:${PATH}"
  before_install:
    - curl -L https://github.com/stedolan/jq/releases/download/jq-1.5/jq-osx-amd64 -o /usr/local/bin/jq
    - chmod 755 /usr/local/bin/jq
    - ./build-support/bin/install_aws_cli_for_ci.sh
    - ./build-support/bin/install_python_for_ci.sh "${PYENV_PY27_VERSION}" "${PYENV_PY36_VERSION}"

py36_osx_config: &py36_osx_config
  <<: *base_osx_config
  # NB: We ensure sane python2 and python3 interpreters are available on the PATH for scripting
  # against.
  env:
    - &py36_osx_config_env >
      PATH="/usr/local/opt/openssl/bin:${PATH}"
      LDFLAGS="-L/usr/local/opt/openssl/lib"
      CPPFLAGS="-I/usr/local/opt/openssl/include"
      PATH="${PYENV_ROOT}/versions/${PYENV_PY27_VERSION}/bin:${PATH}"
      PATH="${PYENV_ROOT}/versions/${PYENV_PY36_VERSION}/bin:${PATH}"
  before_install:
    - curl -L https://github.com/stedolan/jq/releases/download/jq-1.5/jq-osx-amd64 -o /usr/local/bin/jq
    - chmod 755 /usr/local/bin/jq
    - ./build-support/bin/install_aws_cli_for_ci.sh
    - ./build-support/bin/install_python_for_ci.sh "${PYENV_PY27_VERSION}" "${PYENV_PY36_VERSION}"

py37_osx_config: &py37_osx_config
  <<: *base_osx_config
  # NB: We ensure sane python2 and python3 interpreters are available on the PATH for scripting
  # against.
  env:
    - &py37_osx_config_env >
      PATH="/usr/local/opt/openssl/bin:${PATH}"
      LDFLAGS="-L/usr/local/opt/openssl/lib"
      CPPFLAGS="-I/usr/local/opt/openssl/include"
      PATH="${PYENV_ROOT}/versions/${PYENV_PY27_VERSION}/bin:${PATH}"
      PATH="${PYENV_ROOT}/versions/${PYENV_PY37_VERSION}/bin:${PATH}"
  before_install:
    - curl -L https://github.com/stedolan/jq/releases/download/jq-1.5/jq-osx-amd64 -o /usr/local/bin/jq
    - chmod 755 /usr/local/bin/jq
    - ./build-support/bin/install_aws_cli_for_ci.sh
    - ./build-support/bin/install_python_for_ci.sh "${PYENV_PY27_VERSION}" "${PYENV_PY37_VERSION}"

base_osx_test_config: &base_osx_test_config
  <<: *pants_run_cache_config
  before_script:
    - ulimit -c unlimited
    - ulimit -n 8192
    - *aws_get_pants_pex

py27_osx_test_config: &py27_osx_test_config
  <<: *py27_osx_config
  <<: *base_osx_test_config
  env:
    - &py27_osx_test_config_env >
      PATH="/usr/local/opt/openssl/bin:${PATH}"
      LDFLAGS="-L/usr/local/opt/openssl/lib"
      CPPFLAGS="-I/usr/local/opt/openssl/include"
      BOOTSTRAPPED_PEX_KEY_SUFFIX=py27.osx
      PATH="${PYENV_ROOT}/versions/${PYENV_PY27_VERSION}/bin:${PATH}"
      PATH="${PYENV_ROOT}/versions/${PYENV_PY36_VERSION}/bin:${PATH}"

py36_osx_test_config: &py36_osx_test_config
  <<: *py36_osx_config
  <<: *base_osx_test_config
  env:
    - &py36_osx_test_config_env >
      PATH="/usr/local/opt/openssl/bin:${PATH}"
      LDFLAGS="-L/usr/local/opt/openssl/lib"
      CPPFLAGS="-I/usr/local/opt/openssl/include"
      BOOTSTRAPPED_PEX_KEY_SUFFIX=py36.osx
      PATH="${PYENV_ROOT}/versions/${PYENV_PY27_VERSION}/bin:${PATH}"
      PATH="${PYENV_ROOT}/versions/${PYENV_PY36_VERSION}/bin:${PATH}"

py37_osx_test_config: &py37_osx_test_config
  <<: *py37_osx_config
  <<: *base_osx_test_config
  env:
    - &py37_osx_test_config_env >
      PATH="/usr/local/opt/openssl/bin:${PATH}"
      LDFLAGS="-L/usr/local/opt/openssl/lib"
      CPPFLAGS="-I/usr/local/opt/openssl/include"
      BOOTSTRAPPED_PEX_KEY_SUFFIX=py37.osx
      PATH="${PYENV_ROOT}/versions/${PYENV_PY27_VERSION}/bin:${PATH}"
      PATH="${PYENV_ROOT}/versions/${PYENV_PY37_VERSION}/bin:${PATH}"

linux_with_fuse: &linux_with_fuse
  os: linux
  dist: xenial
  sudo: required
  before_install:
    - PATH="/usr/lib/jvm/java-8-openjdk-amd64/jre/bin":$PATH
    - JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
    - sudo sysctl fs.inotify.max_user_watches=524288
    - ./build-support/bin/install_aws_cli_for_ci.sh
    - pyenv global 2.7.15 3.6.7 3.7.1
    - sudo apt-get install -y pkg-config fuse libfuse-dev
    - sudo modprobe fuse
    - sudo chmod 666 /dev/fuse
    - sudo chown root:$USER /etc/fuse.conf
  python:
    - "2.7"
    - "3.6"
    - "3.7"

travis_docker_image: &travis_docker_image
  services:
    - docker
  before_script:
    - ulimit -c unlimited

# -------------------------------------------------------------------------
# Build wheels
# -------------------------------------------------------------------------

# N.B. With Python 2, we must build pantsbuild.pants with both UCS2 and UCS4 to provide full
# compatibility for end users. This is because we constrain our ABI due to the native engine.
# See https://www.python.org/dev/peps/pep-0513/#ucs-2-vs-ucs-4-builds. Note this distinction is
# not necessary with Python 3.3+ due to flexible storage of Unicode strings (https://www.python.org/dev/peps/pep-0393/).
#
# We treat both Linux UCS4 and OSX UCS2 normally, as these are the defaults for those environments.
# The Linux UCS2 and OSX UCS4 shards, however, must rebuild Python with
# `PYTHON_CONFIGURE_OPTS=--enable-unicode=ucs{2,4}` set, along with bootstrapping Pants again rather
# than pulling the PEX from AWS.

base_build_wheels: &base_build_wheels
  env:
    - &base_build_wheels_env PREPARE_DEPLOY=1

base_linux_build_wheels: &base_linux_build_wheels
  # Similar to the bootstrap shard, we build Linux wheels in a docker image to maximize compatibility.
  <<: *travis_docker_image
  <<: *base_build_wheels
  # Callers of this anchor are expected to provide values in their `env` for
  # `docker_image_name` and `docker_run_command` (i.e. the bash command(s) to run).
  script:
    - >
      docker build
      --rm -t ${docker_image_name}
      --build-arg "TRAVIS_USER=$(id -un)"
      --build-arg "TRAVIS_UID=$(id -u)"
      --build-arg "TRAVIS_GROUP=$(id -gn)"
      --build-arg "TRAVIS_GID=$(id -g)"
      build-support/docker/${docker_image_name}/
    - >
      docker run
      --rm -t
      -v "${HOME}:/travis/home"
      -v "${TRAVIS_BUILD_DIR}:/travis/workdir"
      ${docker_image_name}:latest
      sh -c "${docker_run_command}"

py27_linux_build_wheels_ucs2: &py27_linux_build_wheels_ucs2
  <<: *py27_linux_config
  <<: *base_linux_build_wheels
  <<: *native_engine_cache_config
  name: "Build wheels - Linux and cp27m (UCS2)"
  env:
    - *base_build_wheels_env
    - docker_image_name=travis_ci_py27_ucs2
    - docker_run_command="./build-support/bin/ci.sh -2b
                          && ./build-support/bin/check_pants_pex_abi.py cp27m
                          && ./build-support/bin/release.sh -2n"
    - CACHE_NAME=linuxwheelsbuild.ucs2

py27_linux_build_wheels_ucs4: &py27_linux_build_wheels_ucs4
  <<: *base_linux_build_wheels
  <<: *py27_linux_test_config
  # `py27_linux_test_config` overrides the stage set by `base_build_wheels`, so we re-override it.
  name: "Build wheels - Linux and cp27mu (UCS4)"
  env:
    - *py27_linux_test_config_env
    - *base_build_wheels_env
    - docker_image_name=travis_ci
    - docker_run_command="./build-support/bin/check_pants_pex_abi.py cp27mu
                          && ./build-support/bin/release.sh -2n"
    - CACHE_NAME=linuxwheelsbuild.ucs4

py36_linux_build_wheels: &py36_linux_build_wheels
  <<: *base_linux_build_wheels
  <<: *py36_linux_test_config
  name: "Build wheels - Linux and abi3 (Py3.6+)"
  env:
    - *py36_linux_test_config_env
    - *base_build_wheels_env
    - docker_image_name=travis_ci
    - docker_run_command="./build-support/bin/check_pants_pex_abi.py abi3 cp36m
                          && ./build-support/bin/release.sh -n"
    - CACHE_NAME=linuxwheelsbuild.abi3
