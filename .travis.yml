# GENERATED, DO NOT EDIT!
# To change, edit `build-support/bin/generate_travis_yml.py` and run:
# ./pants --quiet run build-support/bin:generate_travis_yml > .travis.yml


conditions: v1
deploy:
  'on':
    all_branches: true
    condition: $PREPARE_DEPLOY = 1
    repo: pantsbuild/pants
  provider: script
  script: ./build-support/bin/deploy_to_s3.py
  skip_cleanup: true
env:
  global:
  - PANTS_CONFIG_FILES="${TRAVIS_BUILD_DIR}/pants.travis-ci.ini"
  - LC_ALL="en_US.UTF-8"
  - BOOTSTRAPPED_PEX_BUCKET=ci-public.pantsbuild.org
  - BOOTSTRAPPED_PEX_KEY_PREFIX=${TRAVIS_BUILD_NUMBER}/${TRAVIS_BUILD_ID}/pants.pex
  - BOOTSTRAPPED_PEX_URL_PREFIX=s3://${BOOTSTRAPPED_PEX_BUCKET}/${BOOTSTRAPPED_PEX_KEY_PREFIX}
  - PYENV_PY27_VERSION=2.7.15
  - PYENV_PY36_VERSION=3.6.8
  - PYENV_PY37_VERSION=3.7.2
  - PYENV_ROOT_OSX=${HOME}/.pants_pyenv
  - PYENV_ROOT="${PYENV_ROOT:-${PYENV_ROOT_OSX}}"
  - PATH="${PYENV_ROOT}/shims:${PATH}"
  - AWS_CLI_ROOT="${HOME}/.aws_cli"
  - AWS_ACCESS_KEY_ID__TO_BE_REEXPORTED_ON_DEPLOYS=AKIAV6A6G7RQWPRUWIXR
  - secure: hFVAQGLVkexzTd3f9NF+JoG1dE+CPICKqOcdvQYv8+YB2rwwqu0/J6MnqKUZSmec4AM4ZvyPUBIHnSw8aMJysYs+GZ6iG/8ZRRmdbmo2WBPbSZ+ThRZxx/F6AjmovUmf8Zt366ZAZXpc9NHKREkTUGl6UL7FFe9+ouVnb90asdw=
  - RUST_BACKTRACE="all"
matrix:
  include:
  - before_cache:
    - sudo chown -R travis:travis "${HOME}" "${TRAVIS_BUILD_DIR}"
    - find build-support -name "*.py[co]" -delete
    - ./build-support/bin/prune_travis_cache.sh
    before_install:
    - curl -L https://github.com/stedolan/jq/releases/download/jq-1.5/jq-osx-amd64
      -o /usr/local/bin/jq
    - chmod 755 /usr/local/bin/jq
    - ./build-support/bin/install_aws_cli_for_ci.sh
    - ./build-support/bin/install_python_for_ci.sh "${PYENV_PY27_VERSION}" "${PYENV_PY36_VERSION}"
    before_script:
    - ulimit -c unlimited
    - ulimit -n 8192
#    - ./build-support/bin/get_ci_bootstrapped_pants_pex.sh ${BOOTSTRAPPED_PEX_BUCKET}
#      ${BOOTSTRAPPED_PEX_KEY_PREFIX}.${BOOTSTRAPPED_PEX_KEY_SUFFIX}
    cache:
      directories:
      - ${AWS_CLI_ROOT}
      - ${PYENV_ROOT_OSX}
      - ${HOME}/.cache/pants/rust/cargo
      - build-support/virtualenvs
      - src/rust/engine/target
      timeout: 500
    env:
    - PATH="/usr/local/opt/openssl/bin:${PATH}"
    - LDFLAGS="-L/usr/local/opt/openssl/lib"
    - CPPFLAGS="-I/usr/local/opt/openssl/include"
    - PATH="${PYENV_ROOT}/versions/${PYENV_PY27_VERSION}/bin:${PATH}"
    - PATH="${PYENV_ROOT}/versions/${PYENV_PY36_VERSION}/bin:${PATH}"
    - BOOTSTRAPPED_PEX_KEY_SUFFIX=py36.osx
    - CACHE_NAME=test_es
    language: generic
    name: Test ES
    os: osx
    script:
    - ./build-support/bin/ci.py --bootstrap
    - './untilfail.py ./pants.pex --cache-ignore test test tests/python/pants_test/base/es:prints_traceback_on_sigusr2'
    stage: Bootstrap Pants
stages:
- if: type != cron
  name: Bootstrap Pants
- if: type = cron
  name: Bootstrap Pants (Cron)
- if: type != cron
  name: Test Pants
- if: type = cron
  name: Test Pants (Cron)
- if: tag IS present AND tag =~ ^release_.*$
  name: Deploy Pants Pex
- if: tag IS NOT present AND type NOT IN (pull_request, cron)
  name: Deploy Pants Pex Unstable

